<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Visitas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.46.0/dist/apexcharts.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">

<div class="max-w-6xl mx-auto px-4 py-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
        <h1 class="text-3xl font-bold">Dashboard de Visitas</h1>
        <div class="flex gap-2">
            <button id="scroll-registros"
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-sm font-medium">
                Ver registros
            </button>
            <button id="logout-btn"
                    class="inline-flex items-center justify-center px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-sm font-medium">
                Cerrar sesión
            </button>
        </div>
    </div>

    <!-- Métricas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-4">
            <p class="text-sm text-gray-400">Visitas totales</p>
            <p id="total-visitas" class="mt-2 text-2xl font-bold">-</p>
        </div>
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-4">
            <p class="text-sm text-gray-400">Visitas hoy</p>
            <p id="visitas-hoy" class="mt-2 text-2xl font-bold">-</p>
        </div>
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-4">
            <p class="text-sm text-gray-400">Visitas activas</p>
            <p id="visitas-activas" class="mt-2 text-2xl font-bold">-</p>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Visitas por día -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold">Visitas por día</h2>
                    <p class="text-xs text-gray-400">Últimos 7 días</p>
                </div>
            </div>
            <div class="mt-2" id="visitasPorDiaChart"></div>
        </div>

        <!-- Estado de visitas -->
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow p-4 md:p-6">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <h2 class="text-lg font-semibold">Estado de las visitas</h2>
                    <p class="text-xs text-gray-400">Finalizadas vs. incompletas</p>
                </div>
            </div>
            <div class="mt-2" id="estadoVisitasChart"></div>
        </div>
    </div>
    <!--  TABLA DE REGISTROS      -->
    <section id="seccion-registros">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
            <h2 class="text-2xl font-bold">Lista de registros</h2>

            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-300">Ordenar por:</span>
                <select id="orden-select"
                        class="text-sm rounded-lg border border-gray-700 bg-gray-800 px-3 py-2 text-white">
                    <option value="entrada_desc">Hora entrada (más recientes)</option>
                    <option value="entrada_asc">Hora entrada (más antiguos)</option>
                    <option value="salida_desc">Hora salida (más recientes)</option>
                    <option value="salida_asc">Hora salida (más antiguos)</option>
                    <option value="nombre_asc">Nombre (A-Z)</option>
                    <option value="nombre_desc">Nombre (Z-A)</option>
                </select>
            </div>
        </div>

        <div class="relative overflow-x-auto bg-gray-800 rounded-lg shadow border border-gray-700">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-700 text-gray-100 border-b border-gray-600">
                <tr>
                    <th class="px-6 py-3 font-medium">Nombre</th>
                    <th class="px-6 py-3 font-medium">RUT</th>
                    <th class="px-6 py-3 font-medium">Motivo</th>
                    <th class="px-6 py-3 font-medium">Hora Entrada</th>
                    <th class="px-6 py-3 font-medium">Hora Salida</th>
                    <th class="px-6 py-3 font-medium">Estado</th>
                </tr>
                </thead>
                <tbody id="registros-list">
                <!-- filas generadas por JS -->
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
    // Autenticación
    const accessToken = localStorage.getItem('access_token');
    if (!accessToken) {
        alert('No has iniciado sesión. Redirigiendo...');
        window.location.href = './index.html';
    }

    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('access_token');
        window.location.href = './index.html';
    });

    document.getElementById('scroll-registros').addEventListener('click', () => {
        document.getElementById('seccion-registros').scrollIntoView({ behavior: 'smooth' });
    });

    // Dashboard 
    async function fetchDashboard() {
        const response = await fetch('https://sistema-de-registro-de-visitas.onrender.com/api/dashboard/', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        const data = await response.json();

        if (!response.ok) {
            alert("Error al cargar dashboard: " + (data.detail || ""));
            return;
        }

        // Métricas
        document.getElementById('total-visitas').innerText = data.total_visitas;
        document.getElementById('visitas-hoy').innerText = data.visitas_hoy;
        document.getElementById('visitas-activas').innerText = data.visitas_activas;

        // Gráfico Visitas por día
        const labelsDia = data.visitas_por_dia.map(item => {
            const [year, month, day] = item.dia.split('-');
            return `${day}/${month}`;  // dd/mm
        });
        const valoresDia = data.visitas_por_dia.map(item => item.total);

        const opcionesVisitasDia = {
            chart: {
                type: 'bar',
                height: 260,
                toolbar: { show: false },
                foreColor: '#9CA3AF',
                background: 'transparent',
            },
            series: [{ name: 'Visitas', data: valoresDia }],
            xaxis: {
                categories: labelsDia,
                axisBorder: { show: false },
                axisTicks: { show: false },
            },
            yaxis: {
                labels: { formatter: val => val.toFixed(0) }
            },
            grid: {
                borderColor: '#374151',
                strokeDashArray: 4,
            },
            colors: ['#6366F1'],
            dataLabels: { enabled: false },
            plotOptions: {
                bar: { borderRadius: 4, columnWidth: '45%' }
            }
        };

        new ApexCharts(
            document.querySelector("#visitasPorDiaChart"),
            opcionesVisitasDia
        ).render();

        // Gráfico Estado de visitas 
        const finalizadas = data.estados.finalizadas || 0;
        const incompletas = data.estados.incompletas || 0;

        const opcionesEstado = {
            chart: {
                type: 'donut',
                height: 260,
                toolbar: { show: false },
                foreColor: '#9CA3AF',
                background: 'transparent',
            },
            series: [finalizadas, incompletas],
            labels: ['Finalizadas', 'Incompletas'],
            colors: ['#22C55E', '#EF4444'],
            legend: {
                position: 'bottom',
                labels: { colors: '#E5E7EB' }
            },
            dataLabels: {
                formatter: (val, opts) => {
                    const valor = opts.w.globals.series[opts.seriesIndex];
                    return `${valor} (${val.toFixed(1)}%)`;
                }
            }
        };

        new ApexCharts(
            document.querySelector("#estadoVisitasChart"),
            opcionesEstado
        ).render();
    }

    // Tabla de registros
    const registrosList = document.getElementById('registros-list');
    const ordenSelect = document.getElementById('orden-select');
    let registrosOriginales = [];

    function formatFecha(fechaString) {
        if (!fechaString) return "-";
        const fecha = new Date(fechaString);
        const fechaISO = fecha.toISOString();
        const [fechaParte, horaParte] = fechaISO.replace("T", " ").slice(0, 19).split(" ");
        const [year, month, day] = fechaParte.split("-");
        const [hour, minute] = horaParte.split(":");
        return `${hour}:${minute} - ${day}/${month}/${year}`;
    }

    function timeFromString(str) {
        return str ? new Date(str).getTime() : 0;
    }

    function renderRegistros(lista) {
        registrosList.innerHTML = '';
        lista.forEach(registro => {
            const tr = document.createElement('tr');
            tr.classList.add("border-b", "border-gray-700");

            const estadoTexto = registro.estado_finalizado ? 'Finalizado' : 'Incompleto';

            tr.innerHTML = `
                <td class="px-6 py-3">${registro.nombre}</td>
                <td class="px-6 py-3">${registro.rut}</td>
                <td class="px-6 py-3">${registro.motivo}</td>
                <td class="px-6 py-3">${formatFecha(registro.horaentrada)}</td>
                <td class="px-6 py-3">${formatFecha(registro.horasalida)}</td>
                <td class="px-6 py-3">${estadoTexto}</td>
            `;
            registrosList.appendChild(tr);
        });
    }

    function aplicarOrdenYRender() {
        if (!registrosOriginales.length) return;

        const valor = ordenSelect.value;
        const listaOrdenada = [...registrosOriginales];

        if (valor === 'entrada_desc') {
            listaOrdenada.sort((a, b) => timeFromString(b.horaentrada) - timeFromString(a.horaentrada));
        } else if (valor === 'entrada_asc') {
            listaOrdenada.sort((a, b) => timeFromString(a.horaentrada) - timeFromString(b.horaentrada));
        } else if (valor === 'salida_desc') {
            listaOrdenada.sort((a, b) => timeFromString(b.horasalida) - timeFromString(a.horasalida));
        } else if (valor === 'salida_asc') {
            listaOrdenada.sort((a, b) => timeFromString(a.horasalida) - timeFromString(b.horasalida));
        } else if (valor === 'nombre_asc') {
            listaOrdenada.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
        } else if (valor === 'nombre_desc') {
            listaOrdenada.sort((a, b) => (b.nombre || "").localeCompare(a.nombre || ""));
        }

        renderRegistros(listaOrdenada);
    }

    async function fetchRegistros() {
        const response = await fetch('https://sistema-de-registro-de-visitas.onrender.com/api/registros/', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });

        const data = await response.json();

        if (!response.ok) {
            alert("Error al cargar registros: " + (data.detail || ""));
            return;
        }

        registrosOriginales = data.results || data || [];
        aplicarOrdenYRender();
    }

    ordenSelect.addEventListener('change', aplicarOrdenYRender);

    // Inicialización
    fetchDashboard();
    fetchRegistros();
</script>

</body>
</html>