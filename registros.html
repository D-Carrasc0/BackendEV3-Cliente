<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Registros</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 p-6">

    <!-- Contenedor de título y botón de cerrar sesión -->
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-white">Lista de Registros</h2>

        <button id="logout-btn" 
            class="w-full sm:w-auto text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-800">
            Cerrar sesión
        </button>
    </div>

    <!-- Selector de orden -->
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-700 dark:text-gray-300">Ordenar por:</span>
            <select id="orden-select" class="text-sm rounded-lg border border-gray-300 bg-white px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                <option value="entrada_desc">Hora entrada (más recientes)</option>
                <option value="entrada_asc">Hora entrada (más antiguos)</option>
                <option value="salida_desc">Hora salida (más recientes)</option>
                <option value="salida_asc">Hora salida (más antiguos)</option>
                <option value="nombre_asc">Nombre (A-Z)</option>
                <option value="nombre_desc">Nombre (Z-A)</option>
            </select>
        </div>
    </div>

    <!-- Tabla de Registros -->
    <div class="relative overflow-x-auto bg-white rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">
        <table class="w-full text-sm text-left">
            <thead class="bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white border-b border-gray-300 dark:border-gray-600">
                <tr>
                    <th class="px-6 py-3 font-medium">Nombre</th>
                    <th class="px-6 py-3 font-medium">RUT</th>
                    <th class="px-6 py-3 font-medium">Motivo</th>
                    <th class="px-6 py-3 font-medium">Hora Entrada</th>
                    <th class="px-6 py-3 font-medium">Hora Salida</th>
                    <!-- NUEVA COLUMNA -->
                    <th class="px-6 py-3 font-medium">Estado</th>
                </tr>
            </thead>
            <tbody id="registros-list">
                <!-- Aquí se llenarán los registros -->
            </tbody>
        </table>
    </div>

    <script>
        const registrosList = document.getElementById('registros-list');
        const logoutButton = document.getElementById('logout-btn');
        const ordenSelect = document.getElementById('orden-select');

        const accessToken = localStorage.getItem('access_token');

        if (!accessToken) {
            alert('No has iniciado sesión. Redirigiendo...');
            window.location.href = './index.html';
        }

        // Guardamos los registros originales aquí
        let registrosOriginales = [];

        // Función para convertir la fecha a formato deseado
        function formatFecha(fechaString) {
            if (!fechaString) return "-";

            const fecha = new Date(fechaString);
            const fechaISO = fecha.toISOString(); // Formato UTC

            const fechaFormateada = fechaISO.replace("T", " ").slice(0, 19); // "2025-10-30 22:01:08"
            const partes = fechaFormateada.split(" ");
            const fechaParte = partes[0].split("-"); // [2025, 10, 30]
            const horaParte = partes[1].split(":");  // [22, 01, 08]

            return `${horaParte[0]}:${horaParte[1]} - ${fechaParte[2]}/${fechaParte[1]}/${fechaParte[0]}`;
        }

        // Convierte string de fecha a timestamp (para comparar fácilmente)
        function timeFromString(str) {
            return str ? new Date(str).getTime() : 0;
        }

        // Pinta la tabla con la lista que se le pase
        function renderRegistros(lista) {
            registrosList.innerHTML = '';

            lista.forEach(registro => {
                const tr = document.createElement('tr');
                tr.classList.add("border-b", "border-gray-300", "dark:border-gray-600");

                const estadoTexto = registro.estado_finalizado ? 'Finalizado' : 'Incompleto';

                tr.innerHTML = `
                    <td class="px-6 py-4 text-gray-900 dark:text-white">${registro.nombre}</td>
                    <td class="px-6 py-4 text-gray-900 dark:text-white">${registro.rut}</td>
                    <td class="px-6 py-4 text-gray-900 dark:text-white">${registro.motivo}</td>
                    <td class="px-6 py-4 text-gray-900 dark:text-white">${formatFecha(registro.horaentrada)}</td>
                    <td class="px-6 py-4 text-gray-900 dark:text-white">${formatFecha(registro.horasalida)}</td>
                    <td class="px-6 py-4 text-gray-900 dark:text-white">${estadoTexto}</td>
                `;

                registrosList.appendChild(tr);
            });
        }

        // Aplica el tipo de orden seleccionado y vuelve a pintar
        function aplicarOrdenYRender() {
            if (!registrosOriginales.length) return;

            const valor = ordenSelect.value;
            const listaOrdenada = [...registrosOriginales]; // copiamos para no mutar el original

            if (valor === 'entrada_desc') {
                listaOrdenada.sort((a, b) => timeFromString(b.horaentrada) - timeFromString(a.horaentrada));
            } else if (valor === 'entrada_asc') {
                listaOrdenada.sort((a, b) => timeFromString(a.horaentrada) - timeFromString(b.horaentrada));
            } else if (valor === 'salida_desc') {
                listaOrdenada.sort((a, b) => timeFromString(b.horasalida) - timeFromString(a.horasalida));
            } else if (valor === 'salida_asc') {
                listaOrdenada.sort((a, b) => timeFromString(a.horasalida) - timeFromString(b.horasalida));
            } else if (valor === 'nombre_asc') {
                listaOrdenada.sort((a, b) => (a.nombre || "").localeCompare(b.nombre || ""));
            } else if (valor === 'nombre_desc') {
                listaOrdenada.sort((a, b) => (b.nombre || "").localeCompare(a.nombre || ""));
            }

            renderRegistros(listaOrdenada);
        }

        async function fetchRegistros() {
            const response = await fetch('https://sistema-de-registro-de-visitas.onrender.com/api/registros/', {
                method: 'GET',
                headers: { 'Authorization': `Bearer ${accessToken}` },
            });

            const data = await response.json();

            if (!response.ok) {
                alert("Error: " + (data.detail || "No se pudieron cargar los registros"));
                return;
            }

            // Aquí guardamos los datos originales
            registrosOriginales = data.results || [];

            // Pinta usando el orden seleccionado por defecto
            aplicarOrdenYRender();
        }

        fetchRegistros();

        // Cada vez que el usuario cambia el select, se vuelve a ordenar
        ordenSelect.addEventListener('change', aplicarOrdenYRender);

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('access_token');
            window.location.href = './index.html';
        });
    </script>

</body>
</html>